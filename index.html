<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Voting</title>
        <script src="https://code.jquery.com/jquery.min.js"></script>
        <script src="https://cdn.rawgit.com/ethereum/web3.js/1.0/dist/web3.min.js"></script>
        <script src="Vote.js"></script>
	      <link rel="stylesheet" type="text/css" href="mystyle.css">
    </head>
    <body>
        <strong><big>2018 이천고 학생회장 모의선거</big></strong> <br />
        <label><input type="radio" name="select" value="1"/> 찬성 </label>
        <label><input type="radio" name="select" value="2"/> 반대 </label> <!추가로 필요한 경우 복사해서 value 값만 바꿔서 사용. 5이상이 필요한 경우 스마트 컨트랙트에서도 수정 필요.>
        <button id="send" onclick="load();" type="button">Send</button><br /><br><br>
        <input type="password" id="privatekey" ><br>
	      <input type="text" id="error" disabled><br>
        <div id="loading">
          <img src="images/loading.gif" alt="Loading..." />
        </div>

        <script>
          let contract,i,check,gasprice,data,gaslimit;
          const ContractAddress='0x4e10df6ab757be3ccadedef35f44c019a15e5535';
          const web3 = new Web3(new Web3.providers.HttpProvider('https://ropsten.infura.io/'));
          contract = new web3.eth.Contract(ABI,ContractAddress);


          function load() {
	          $('#loading').show();
            check = document.getElementsByName('select');
            for(i=0;i<1;i++){
              if(check[i].checked==true){
                break;
              }
            }
            addAccount();
          }
          function addAccount(){
            let key = document.getElementById('privatekey').value;
            web3.eth.accounts.wallet.add('0x'+key);
            getprice();
          }

          function getprice() {
            gasprice;
            web3.eth.getGasPrice(function(err,res){
              if(!err){
                gasprice=res;
                getData();
              }else{
                console.log(err)
              }
            });
          }

          function getData(){
            data=contract.methods.vote(Number(check[i].value)).encodeABI();
            getLimit();
          }

          function getLimit(){
            web3.eth.estimateGas({
              from: web3.eth.accounts.wallet[0].address,
              to: ContractAddress,
              data: data
            }, function(err,res){
              if(!err){
                gaslimit=res;
                transfer();
              }else{
                console.log(err);
              }
            });
          }

          function transfer() {
            contract.methods.vote(Number(check[i].value)).send({
              nonce: web3.eth.getTransactionCount("0x3e62Ffa65462F1a76E3f8c3D4F90F319570af5fD"),
              from: web3.eth.accounts.wallet[0].address,
              gasPrice: String(gasprice*1.4),
              gas: String(gaslimit),
              value: "0"
            }, function(err,res){
              if(!err) {
                console.log(gasprice,gaslimit)
                web3.eth.accounts.wallet.clear;
                location.href="done.html";
              }else{
                console.error(err);
                $('#loading').hide();
	            }
            });
          }

        </script>
	<script language="javascript" type="text/javascript">
            $(window).ready(function() {
                $('#loading').hide();
            });
        </script>
    </body>
</html>
